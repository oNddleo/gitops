apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: infrastructure
  sources:
    # Source 1: Helm Chart
    - repoURL: https://traefik.github.io/charts
      chart: traefik
      targetRevision: 37.4.0
      helm:
        releaseName: traefik
        valuesObject:
          deployment:
            enabled: true
            kind: Deployment
            replicas: 1  # Single node K3s
            podAnnotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "9100"
          service:
            enabled: true
            type: LoadBalancer
          ports:
            web:
              port: 80
              exposedPort: 80
              protocol: TCP
            websecure:
              port: 443
              exposedPort: 443
              protocol: TCP
              tls:
                enabled: true
            metrics:
              port: 9100
              expose: true
              exposedPort: 9100
              protocol: TCP
          ingressRoute:
            dashboard:
              enabled: false
          logs:
            general:
              level: INFO
            access:
              enabled: true
              format: json
          metrics:
            prometheus:
              enabled: true
              entryPoint: metrics
              addEntryPointsLabels: true
              addRoutersLabels: true
              addServicesLabels: true
          additionalArguments:
            - "--api.dashboard=true"
            - "--api.insecure=false"
            - "--ping=true"
            - "--providers.kubernetescrd.allowCrossNamespace=true"
            - "--providers.kubernetescrd.allowExternalNameServices=true"
            - "--serversTransport.insecureSkipVerify=true"
          globalArguments:
            - "--global.checknewversion"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          securityContext:
            capabilities:
              drop: [ALL]
              add: [NET_BIND_SERVICE]
            readOnlyRootFilesystem: true
            runAsGroup: 65532
            runAsNonRoot: true
            runAsUser: 65532
          podSecurityContext:
            fsGroup: 65532
          autoscaling:
            enabled: false  # Disabled for single node
          serviceAccount:
            create: true
            name: traefik

    # Source 2: Kustomize Overlay
    - repoURL: https://github.com/oNddleo/gitops.git
      targetRevision: HEAD
      path: infrastructure/traefik/overlays/dev
  destination:
    server: https://kubernetes.default.svc
    namespace: traefik
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
