apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: linkerd

# Linkerd requires certificates to be generated before installation
# Run the cert-generation script first

helmCharts:
  # Install Linkerd CRDs first
  - name: linkerd-crds
    repo: https://helm.linkerd.io/stable
    version: 1.8.0
    releaseName: linkerd-crds
    namespace: linkerd

  # Install Linkerd control plane
  - name: linkerd-control-plane
    repo: https://helm.linkerd.io/stable
    version: 1.16.11
    releaseName: linkerd-control-plane
    namespace: linkerd
    valuesInline:
      # Identity and mTLS configuration
      identity:
        issuer:
          scheme: kubernetes.io/tls

      # High availability configuration
      controllerReplicas: 3
      controllerResources:
        cpu:
          request: 100m
        memory:
          request: 128Mi
        limit:
          cpu: 1000m
          memory: 1Gi

      # Destination controller
      destinationResources:
        cpu:
          request: 100m
        memory:
          request: 128Mi
        limit:
          cpu: 1000m
          memory: 512Mi

      # Proxy configuration
      proxy:
        # Enable automatic mTLS
        enableExternalProfiles: true
        resources:
          cpu:
            request: 100m
          memory:
            request: 128Mi
          limit:
            cpu: 500m
            memory: 256Mi

      # Proxy injector
      proxyInjector:
        externalSecret: true
        resources:
          cpu:
            request: 100m
          memory:
            request: 128Mi
          limit:
            cpu: 500m
            memory: 256Mi

      # Profile validator
      profileValidator:
        externalSecret: true
        resources:
          cpu:
            request: 100m
          memory:
            request: 128Mi
          limit:
            cpu: 500m
            memory: 256Mi

      # Monitoring
      disableHeartBeat: false
      enablePodAntiAffinity: true

  # Install Linkerd Viz (observability)
  - name: linkerd-viz
    repo: https://helm.linkerd.io/stable
    version: 30.12.11
    releaseName: linkerd-viz
    namespace: linkerd-viz
    valuesInline:
      # Dashboard configuration
      dashboard:
        replicas: 2
        resources:
          cpu:
            request: 50m
          memory:
            request: 128Mi
          limit:
            cpu: 500m
            memory: 512Mi

      # Prometheus
      prometheus:
        enabled: true
        resources:
          cpu:
            request: 300m
          memory:
            request: 512Mi
          limit:
            cpu: 1000m
            memory: 2Gi

      # Grafana
      grafana:
        enabled: true
        resources:
          cpu:
            request: 50m
          memory:
            request: 128Mi
          limit:
            cpu: 500m
            memory: 512Mi

resources:
  - linkerd-certificates.yaml
  - linkerd-viz-ingress.yaml
  - namespace-injection.yaml
