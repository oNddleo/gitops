apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: argocd

helmCharts:
  - name: argo-cd
    repo: https://argoproj.github.io/argo-helm
    version: 9.1.5
    releaseName: argocd
    namespace: argocd
    valuesInline:
      global:
        domain: argocd.example.com  # UPDATE THIS

      # Controller configuration
      controller:
        replicas: 2
        resources:
          limits:
            cpu: 1000m
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 1Gi
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true

      # Server configuration
      server:
        replicas: 3
        autoscaling:
          enabled: true
          minReplicas: 3
          maxReplicas: 10
          targetCPUUtilizationPercentage: 80

        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi

        # Ingress configuration - using Traefik IngressRoute instead
        ingress:
          enabled: false

        metrics:
          enabled: true
          serviceMonitor:
            enabled: true

      # Repo server configuration
      repoServer:
        replicas: 3
        autoscaling:
          enabled: true
          minReplicas: 3
          maxReplicas: 10
          targetCPUUtilizationPercentage: 80

        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 250m
            memory: 256Mi

        metrics:
          enabled: true
          serviceMonitor:
            enabled: true

      # Redis HA
      redis-ha:
        enabled: true
        haproxy:
          enabled: true
          replicas: 3
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi

      # Dex (SSO) - disabled for now
      dex:
        enabled: false

      # Notifications controller
      notifications:
        enabled: true
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi

      # ApplicationSet controller
      applicationSet:
        enabled: true
        replicas: 2
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi

      # Configuration
      configs:
        params:
          server.insecure: false
          application.instanceLabelKey: argocd.argoproj.io/instance
          kustomize.buildOptions: --enable-helm

        cm:
          # Enable status badge
          statusbadge.enabled: "true"

          # Timeout settings
          timeout.reconciliation: 180s
          timeout.hard.reconciliation: 0s

          # Resource customizations
          resource.customizations: |
            networking.k8s.io/Ingress:
              health.lua: |
                hs = {}
                hs.status = "Healthy"
                return hs

        rbac:
          policy.default: role:readonly
          policy.csv: |
            p, role:admin, applications, *, */*, allow
            p, role:admin, clusters, *, *, allow
            p, role:admin, repositories, *, *, allow
            p, role:admin, projects, *, *, allow
            p, role:admin, accounts, *, *, allow
            p, role:admin, certificates, *, *, allow
            g, admin, role:admin

resources:
  - argocd-ingress.yaml
  - repository-config.yaml
