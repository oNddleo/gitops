apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: argocd

helmCharts:
  - name: argo-cd
    repo: https://argoproj.github.io/argo-helm
    version: 6.7.3
    releaseName: argocd
    namespace: argocd
    valuesInline:
      global:
        domain: argocd.example.com  # UPDATE THIS

      # Controller configuration
      controller:
        replicas: 2
        resources:
          limits:
            cpu: 1000m
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 1Gi
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true

      # Server configuration
      server:
        replicas: 3
        autoscaling:
          enabled: true
          minReplicas: 3
          maxReplicas: 10
          targetCPUUtilizationPercentage: 80

        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi

        # Ingress configuration - using Traefik IngressRoute instead
        ingress:
          enabled: false

        # Extra containers for Vault plugin
        extraContainers:
          - name: avp
            image: quay.io/argoproj-labs/argocd-vault-plugin:v1.17.0
            command: ["/var/run/argocd/argocd-cmp-server"]
            env:
              - name: AVP_TYPE
                value: vault
              - name: AVP_AUTH_TYPE
                value: k8s
              - name: AVP_K8S_ROLE
                value: argocd
              - name: VAULT_ADDR
                value: http://vault.vault.svc.cluster.local:8200
            volumeMounts:
              - mountPath: /var/run/argocd
                name: var-files
              - mountPath: /home/argocd/cmp-server/plugins
                name: plugins
              - mountPath: /tmp
                name: tmp
              - mountPath: /home/argocd/cmp-server/config/plugin.yaml
                subPath: avp.yaml
                name: cmp-plugin

        volumes:
          - name: cmp-plugin
            configMap:
              name: cmp-plugin
          - name: tmp
            emptyDir: {}

        metrics:
          enabled: true
          serviceMonitor:
            enabled: true

      # Repo server configuration
      repoServer:
        replicas: 3
        autoscaling:
          enabled: true
          minReplicas: 3
          maxReplicas: 10
          targetCPUUtilizationPercentage: 80

        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 250m
            memory: 256Mi

        # Extra containers for Vault plugin
        extraContainers:
          - name: avp
            image: quay.io/argoproj-labs/argocd-vault-plugin:v1.17.0
            command: ["/var/run/argocd/argocd-cmp-server"]
            env:
              - name: AVP_TYPE
                value: vault
              - name: AVP_AUTH_TYPE
                value: k8s
              - name: AVP_K8S_ROLE
                value: argocd
              - name: VAULT_ADDR
                value: http://vault.vault.svc.cluster.local:8200
            volumeMounts:
              - mountPath: /var/run/argocd
                name: var-files
              - mountPath: /home/argocd/cmp-server/plugins
                name: plugins
              - mountPath: /tmp
                name: tmp
              - mountPath: /home/argocd/cmp-server/config/plugin.yaml
                subPath: avp.yaml
                name: cmp-plugin

        volumes:
          - name: cmp-plugin
            configMap:
              name: cmp-plugin
          - name: tmp
            emptyDir: {}

        metrics:
          enabled: true
          serviceMonitor:
            enabled: true

      # Redis HA
      redis-ha:
        enabled: true
        haproxy:
          enabled: true
          replicas: 3
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi

      # Dex (SSO) - disabled for now
      dex:
        enabled: false

      # Notifications controller
      notifications:
        enabled: true
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi

      # ApplicationSet controller
      applicationSet:
        enabled: true
        replicas: 2
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi

      # Configuration
      configs:
        params:
          server.insecure: false
          application.instanceLabelKey: argocd.argoproj.io/instance

        cm:
          # Enable status badge
          statusbadge.enabled: "true"

          # Timeout settings
          timeout.reconciliation: 180s
          timeout.hard.reconciliation: 0s

          # Resource customizations
          resource.customizations: |
            networking.k8s.io/Ingress:
              health.lua: |
                hs = {}
                hs.status = "Healthy"
                return hs

        rbac:
          policy.default: role:readonly
          policy.csv: |
            p, role:admin, applications, *, */*, allow
            p, role:admin, clusters, *, *, allow
            p, role:admin, repositories, *, *, allow
            p, role:admin, projects, *, *, allow
            p, role:admin, accounts, *, *, allow
            p, role:admin, certificates, *, *, allow
            g, admin, role:admin

resources:
  - argocd-ingress.yaml
  - vault-plugin-config.yaml
  - argocd-vault-rbac.yaml
