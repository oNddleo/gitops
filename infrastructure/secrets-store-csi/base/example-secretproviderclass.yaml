# Example SecretProviderClass for AWS Secrets Manager
# This demonstrates how to map AWS secrets to Kubernetes Secrets

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: example-aws-secrets
  namespace: kube-system
spec:
  provider: aws
  parameters:
    # Specify the AWS region
    region: us-east-1  # UPDATE THIS

    # Define which secrets to retrieve from AWS Secrets Manager
    objects: |
      - objectName: "shared/config/jwt-secret"
        objectType: "secretsmanager"
        objectAlias: "jwt-secret"
      - objectName: "shared/config/api-key"
        objectType: "secretsmanager"
        objectAlias: "api-key"

  # Optional: Sync secrets to Kubernetes Secret for use in environment variables
  secretObjects:
    - secretName: example-kubernetes-secret
      type: Opaque
      data:
        - objectName: jwt-secret
          key: JWT_SECRET
        - objectName: api-key
          key: API_KEY

---
# Example with JSON secret and field extraction
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: example-database-credentials
  namespace: kube-system
spec:
  provider: aws
  parameters:
    region: us-east-1  # UPDATE THIS

    # Extract specific fields from a JSON secret
    objects: |
      - objectName: "production/database/credentials"
        objectType: "secretsmanager"
        jmesPath:
          - path: username
            objectAlias: db_username
          - path: password
            objectAlias: db_password
          - path: host
            objectAlias: db_host
          - path: port
            objectAlias: db_port
          - path: database
            objectAlias: db_name

  secretObjects:
    - secretName: database-credentials
      type: Opaque
      data:
        - objectName: db_username
          key: DB_USERNAME
        - objectName: db_password
          key: DB_PASSWORD
        - objectName: db_host
          key: DB_HOST
        - objectName: db_port
          key: DB_PORT
        - objectName: db_name
          key: DB_NAME

---
# Example deployment showing how to use SecretProviderClass
apiVersion: v1
kind: ServiceAccount
metadata:
  name: example-app
  namespace: kube-system
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/gitops-eks-cluster-secrets-csi-driver"  # UPDATE THIS

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
  namespace: kube-system
  labels:
    app: example-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      serviceAccountName: example-app
      containers:
        - name: app
          image: busybox:latest
          command:
            - sleep
            - "3600"

          # Option 1: Use secrets as environment variables (from synced Kubernetes Secret)
          envFrom:
            - secretRef:
                name: example-kubernetes-secret

          # Option 2: Mount secrets as files from CSI volume
          volumeMounts:
            - name: secrets-store
              mountPath: "/mnt/secrets"
              readOnly: true

      volumes:
        - name: secrets-store
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: example-aws-secrets
