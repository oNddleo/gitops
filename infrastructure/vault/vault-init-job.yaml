apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-init-script
  namespace: vault
data:
  init.sh: |
    #!/bin/sh
    set -e

    echo "Waiting for Vault to be ready..."
    until vault status 2>/dev/null; do
      echo "Vault is not ready yet, waiting..."
      sleep 5
    done

    echo "Checking Vault initialization status..."
    if vault status | grep -q "Initialized.*false"; then
      echo "Initializing Vault..."
      vault operator init -key-shares=5 -key-threshold=3 -format=json > /tmp/vault-keys.json

      echo "Vault initialized. Save the following keys securely:"
      cat /tmp/vault-keys.json

      echo "Unsealing Vault..."
      UNSEAL_KEY_1=$(cat /tmp/vault-keys.json | jq -r '.unseal_keys_b64[0]')
      UNSEAL_KEY_2=$(cat /tmp/vault-keys.json | jq -r '.unseal_keys_b64[1]')
      UNSEAL_KEY_3=$(cat /tmp/vault-keys.json | jq -r '.unseal_keys_b64[2]')

      vault operator unseal $UNSEAL_KEY_1
      vault operator unseal $UNSEAL_KEY_2
      vault operator unseal $UNSEAL_KEY_3

      echo "Vault unsealed successfully!"
    else
      echo "Vault is already initialized"
    fi
---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: vault
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    metadata:
      labels:
        app: vault-init
    spec:
      serviceAccountName: vault
      restartPolicy: OnFailure
      containers:
        - name: vault-init
          image: hashicorp/vault:1.15.4
          command: ["/bin/sh", "/scripts/init.sh"]
          env:
            - name: VAULT_ADDR
              value: "http://vault:8200"
          volumeMounts:
            - name: init-script
              mountPath: /scripts
      volumes:
        - name: init-script
          configMap:
            name: vault-init-script
            defaultMode: 0755
