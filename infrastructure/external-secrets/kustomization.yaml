apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: external-secrets-system

helmCharts:
  - name: external-secrets
    repo: https://charts.external-secrets.io
    version: 0.9.13
    releaseName: external-secrets
    namespace: external-secrets-system
    valuesInline:
      # Install CRDs
      installCRDs: true

      # Replicas for HA
      replicaCount: 3

      # Resources
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 50m
          memory: 128Mi

      # Service account
      serviceAccount:
        create: true
        name: external-secrets

      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      # Pod security context
      podSecurityContext:
        runAsNonRoot: true

      # Metrics
      metrics:
        enabled: true
        service:
          enabled: true

      # Service monitor for Prometheus
      serviceMonitor:
        enabled: true

      # Webhook
      webhook:
        create: true
        port: 9443
        replicas: 3
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi

      # Cert controller
      certController:
        create: true
        replicas: 2
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi

resources:
  - vault-secret-store.yaml
  - example-external-secret.yaml
